<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
	<link rel="stylesheet" type="text/css" href="css/plantilla.css">
	<title>Tareas</title>

</head>
<body class="container">
	<div id="registrarTarea" class="col-md-5 col-center"></div>
	<div id="mostrarTareas" class="col-md-5 col-center"></div>
<script>
    let token = localStorage.getItem('token')
	parsedToken = parseJwt(token);
	token = "Bearer " + token;
	parsedToken = parsedToken.authorities[0]

	if ( parsedToken == "admin") {
		let html = `<div class="col-md-12 col-center">
			<div class="form-group">
				<form id="registro-form">
					<p><H2>Registrar nueva tarea</H2></p>
					<hr/>
					<br>
						<p><label>Titulo</label><br> <input class="form-control" id="tituloForm" type="text" name="titulo" maxLength="65" placeholder="Añadir un titulo" required></p>
						<p><label>Descripción</label> <textarea class="form-control" id="descripcionForm" name="descripcion" rows="10" cols="75" placeholder="Ingresar una descripción"	required></textarea></p>
						<p><input type="submit" value="Añadir Tarea" name="registrar" class="btn btn-dark btn-block"/></p><br><br>
				</form>
			</div>
		</div>`;
		$('#registrarTarea').html(html);

		$('#registro-form').submit(function(e) {
			e.preventDefault();

			let url = 'http://localhost:8080/registrar_tarea';
			let postData = {
				titulo: $('#tituloForm').val(),
				descripcion: $('#descripcionForm').val()
			};

			$.ajax({
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json',
					'Authorization': token
				},
				type: "POST",
				url: url,
				data: JSON.stringify(postData),
				dataType: "JSON",
				success: function (data) {
					alert("Tarea creada correctamente!")
				},
				error: function () {
					alert("No se pudo cargar la tarea correctamente")
				}
			});
		});
	}

	obtenerTareas()

	function obtenerTareas(){
		$.ajax({

			url: 'http://localhost:8080/obtener_tareas',
			type: "GET",
			contentType: 'application/json',
			headers: {
				'Authorization': token
			},
			success: function(data) {
				generarTabla(data)
			},
			error: function () {
				alert("Error")
			}
		});
	}

	function generarTabla(data){
		console.log(data)
		let html = `<div class="form-group">
						<table class="table">
							<thead class="thead-dark">
								<tr>
									<th scope="col">Tarea</th>
									<th scope="col">Descripción</th>
								</tr>
							</thead>`

		data.forEach(function(valor){
			html += `<tr>
						<td>`+ valor.titulo +`</td>
						<td>`+ valor.descripcion +`</td>
					</tr>`;
		});
		html += `</table></div>`

		$('#mostrarTareas').html(html);
	}

	function parseJwt(token) {
		let base64Url = token.split('.')[1];
		let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
		let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
			return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
		}).join(''));

		return JSON.parse(jsonPayload);
	};
</script>
</body>
</html>